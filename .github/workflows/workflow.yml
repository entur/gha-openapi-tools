name: gha-openapi-tools

on:
  workflow_call:
    inputs:
      spec_path:
        description: Path to the OpenAPI spec in the caller repo
        required: true
        type: string
      mode:
        description: Which generator types to run (server, client, both)
        default: server
        type: string
      server_generators:
        description: Comma-separated server generator names (defaults to all in server_config_dir)
        required: false
        type: string
      client_generators:
        description: Comma-separated client generator names (defaults to all in client_config_dir)
        required: false
        type: string
      server_config_dir:
        description: Path to server generator configs (only used with use_caller_configs)
        default: generators/server
        type: string
      client_config_dir:
        description: Path to client generator configs (only used with use_caller_configs)
        default: generators/client
        type: string
      generator_image:
        description: Docker image for OpenAPI Generator CLI
        default: openapitools/openapi-generator-cli:v7.17.0
        type: string
      redocly_image:
        description: Docker image for Redocly CLI
        default: redocly/cli:1.25.5
        type: string
      redocly_config:
        description: Optional Redocly config path in the caller repo
        required: false
        type: string
      run_compile:
        description: Compile generated code in Docker
        default: true
        type: boolean
      run_lint:
        description: Run Redocly linting
        default: true
        type: boolean
      run_generate:
        description: Run OpenAPI Generator
        default: true
        type: boolean
      run_upload:
        description: Upload reports artifact
        default: true
        type: boolean
      run_upload_generated:
        description: Upload generated code artifact
        default: false
        type: boolean
      use_caller_configs:
        description: Use generator configs from caller repo instead of embedded defaults
        default: false
        type: boolean

env:
  REPORTS_DIR: ${{ github.workspace }}/reports
  STATUS_FILE: ${{ github.workspace }}/reports/status.tsv
  GENERATED_DIR: ${{ github.workspace }}/generated

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout caller
        uses: actions/checkout@v4

      - name: Prepare workspace
        shell: bash
        run: |
          set -euo pipefail

          # Create reports directories
          mkdir -p "${REPORTS_DIR}/lint" "${REPORTS_DIR}/generate/server" "${REPORTS_DIR}/generate/client" "${REPORTS_DIR}/compile/server" "${REPORTS_DIR}/compile/client"
          : > "${STATUS_FILE}"

          # Create generated output directories
          mkdir -p "${GENERATED_DIR}/server" "${GENERATED_DIR}/client"

          # Create embedded generator configs (only used when use_caller_configs=false)
          mkdir -p generators/server generators/client

          # Server generator configs
          cat > generators/server/aspnetcore.yaml << 'GENEOF'
          generatorName: aspnetcore
          outputDir: generated/server/aspnetcore
          additionalProperties:
            packageName: GeneratedApi
            packageVersion: 1.0.0
            aspnetCoreVersion: "8.0"
            buildTarget: program
            title: Generated API
            operationIsAsync: true
            operationResultTask: true
            generateBody: true
            useDateTimeOffset: true
            useNewtonsoft: false
            nullableReferenceTypes: true
            pocoModels: true
            useSwashbuckle: false
            isLibrary: false
          typeMappings:
            DateTime: DateTimeOffset
          GENEOF

          cat > generators/server/go-server.yaml << 'GENEOF'
          generatorName: go-server
          outputDir: generated/server/go-server
          additionalProperties:
            packageName: openapi
            packageVersion: 1.0.0
            title: Generated API
            serverPort: 8080
            featureCORS: false
            hideGenerationTimestamp: true
            router: chi
            outputAsLibrary: false
            onlyInterfaces: false
            enumClassPrefix: true
          GENEOF

          cat > generators/server/kotlin-spring.yaml << 'GENEOF'
          generatorName: kotlin-spring
          outputDir: generated/server/kotlin-spring
          additionalProperties:
            artifactId: generated-api
            artifactVersion: 1.0.0
            apiPackage: org.example.api
            modelPackage: org.example.model
            title: Generated API
            useTags: true
            interfaceOnly: false
            useSpringBoot3: true
            documentationProvider: source
            useSwaggerUI: false
            useBeanValidation: true
            reactive: false
            exceptionHandler: false
            enumPropertyNaming: UPPERCASE
            serializationLibrary: jackson
            dateLibrary: java8
          GENEOF

          cat > generators/server/python-fastapi.yaml << 'GENEOF'
          generatorName: python-fastapi
          outputDir: generated/server/python-fastapi
          additionalProperties:
            packageName: generated_api
            packageVersion: 1.0.0
            projectName: generated-api
            generateSourceCodeOnly: true
            hideGenerationTimestamp: true
            title: Generated API
          GENEOF

          cat > generators/server/spring.yaml << 'GENEOF'
          generatorName: spring
          outputDir: generated/server/spring
          additionalProperties:
            artifactId: generated-api
            artifactVersion: 1.0.0
            apiPackage: org.example.api
            modelPackage: org.example.model
            title: Generated API
            useTags: true
            interfaceOnly: false
            useSpringBoot3: true
            documentationProvider: source
            useSwaggerUI: false
            useBeanValidation: true
            reactive: false
            exceptionHandler: false
            serializationLibrary: jackson
            dateLibrary: java8
            useJakartaEe: true
            useOneOfInterfaces: false
          GENEOF

          cat > generators/server/typescript-nestjs.yaml << 'GENEOF'
          generatorName: typescript-nestjs
          outputDir: generated/server/typescript-nestjs
          additionalProperties:
            npmName: openapi-server
            npmVersion: 1.0.0
            supportsES6: true
            nestVersion: "8.0.0"
          GENEOF

          # Client generator configs
          cat > generators/client/csharp.yaml << 'GENEOF'
          generatorName: csharp
          outputDir: generated/client/csharp
          additionalProperties:
            packageName: OpenApiClient
            packageVersion: 1.0.0
            targetFramework: net8.0
          GENEOF

          cat > generators/client/go.yaml << 'GENEOF'
          generatorName: go
          outputDir: generated/client/go
          additionalProperties:
            packageName: openapiclient
          GENEOF

          cat > generators/client/java.yaml << 'GENEOF'
          generatorName: java
          outputDir: generated/client/java
          additionalProperties:
            groupId: com.example
            artifactId: openapi-client
            artifactVersion: 1.0.0
            apiPackage: com.example.api
            modelPackage: com.example.model
          GENEOF

          cat > generators/client/kotlin.yaml << 'GENEOF'
          generatorName: kotlin
          outputDir: generated/client/kotlin
          additionalProperties:
            library: jvm-okhttp4
            groupId: com.example
            artifactId: openapi-client
            artifactVersion: 1.0.0
            packageName: com.example.client
          GENEOF

          cat > generators/client/python.yaml << 'GENEOF'
          generatorName: python
          outputDir: generated/client/python
          additionalProperties:
            packageName: openapi_client
            projectName: openapi-client
            packageVersion: 1.0.0
          GENEOF

          cat > generators/client/typescript-axios.yaml << 'GENEOF'
          generatorName: typescript-axios
          outputDir: generated/client/typescript-axios
          additionalProperties:
            npmName: openapi-client
            npmVersion: 1.0.0
            supportsES6: true
          GENEOF

          cat > generators/client/typescript-fetch.yaml << 'GENEOF'
          generatorName: typescript-fetch
          outputDir: generated/client/typescript-fetch
          additionalProperties:
            npmName: openapi-client
            npmVersion: 1.0.0
            supportsES6: true
          GENEOF

          cat > generators/client/typescript-node.yaml << 'GENEOF'
          generatorName: typescript-node
          outputDir: generated/client/typescript-node
          additionalProperties:
            npmName: generated-api-client
            npmVersion: 1.0.0
            supportsES6: true
            enumPropertyNaming: UPPERCASE
            modelPropertyNaming: original
            stringEnums: true
          GENEOF

          # Create docker-compose.yaml for compile step
          cat > docker-compose.yaml << 'COMPOSEEOF'
          services:
            build-aspnetcore:
              image: mcr.microsoft.com/dotnet/sdk:10.0
              volumes:
                - ./generated/server/aspnetcore:/src:rw
                - nuget-cache:/root/.nuget/packages
              working_dir: /src/src/GeneratedApi
              command: dotnet build GeneratedApi.csproj -c Release

            build-go-server:
              image: golang:1.25-alpine
              volumes:
                - ./generated/server/go-server:/src:rw
                - go-pkg-cache:/go/pkg/mod
                - go-build-cache:/root/.cache/go-build
              working_dir: /src
              command: >
                sh -c
                'set -e;
                if test -f go.mod; then
                  go mod tidy && go test ./...;
                elif test -f go/go.mod; then
                  cd go && go mod tidy && go test ./...;
                else
                  go mod init example.com/openapi && go mod tidy && go test ./...;
                fi'

            build-kotlin-spring:
              image: gradle:8-jdk21
              volumes:
                - ./generated/server/kotlin-spring:/src:rw
                - gradle-cache:/home/gradle/.gradle
              working_dir: /src
              command: gradle --no-daemon build -x test

            build-spring:
              image: maven:3-eclipse-temurin-21
              volumes:
                - ./generated/server/spring:/src:rw
                - m2-cache:/root/.m2
              working_dir: /src
              command: mvn -DskipTests package

            build-typescript-nestjs:
              image: node:24-alpine
              volumes:
                - ./generated/server/typescript-nestjs:/src:rw
                - npm-cache:/root/.npm
              working_dir: /src
              command: sh -lc 'npm install && npm run build'

            build-python-fastapi:
              image: python:3.12-slim
              volumes:
                - ./generated/server/python-fastapi:/src:rw
                - pip-cache:/root/.cache/pip
              working_dir: /src
              command: >
                sh -lc
                'apt-get update &&
                apt-get install -y --no-install-recommends g++ make &&
                pip install --no-cache-dir -r requirements.txt &&
                python -m compileall . &&
                apt-get purge -y g++ make &&
                apt-get autoremove -y &&
                rm -rf /var/lib/apt/lists/*'

            build-client-typescript-axios:
              image: node:24-alpine
              volumes:
                - ./generated/client/typescript-axios:/src:rw
                - npm-cache:/root/.npm
              working_dir: /src
              command: sh -lc 'npm install && npx tsc --noEmit'

            build-client-typescript-fetch:
              image: node:24-alpine
              volumes:
                - ./generated/client/typescript-fetch:/src:rw
                - npm-cache:/root/.npm
              working_dir: /src
              command: sh -lc 'npm install && npx tsc --noEmit'

            build-client-typescript-node:
              image: node:24-alpine
              volumes:
                - ./generated/client/typescript-node:/src:rw
                - npm-cache:/root/.npm
              working_dir: /src
              command: sh -lc 'npm install && npx tsc --noEmit'

            build-client-java:
              image: maven:3-eclipse-temurin-21
              volumes:
                - ./generated/client/java:/src:rw
                - m2-cache:/root/.m2
              working_dir: /src
              command: mvn -DskipTests compile

            build-client-go:
              image: golang:1.25-alpine
              volumes:
                - ./generated/client/go:/src:rw
                - go-pkg-cache:/go/pkg/mod
                - go-build-cache:/root/.cache/go-build
              working_dir: /src
              command: sh -c 'set -e; go mod tidy && go build ./...'

            build-client-csharp:
              image: mcr.microsoft.com/dotnet/sdk:10.0
              volumes:
                - ./generated/client/csharp:/src:rw
                - nuget-cache:/root/.nuget/packages
              working_dir: /src
              command: >
                sh -c
                'set -e;
                csproj=$$(find . -name "*.csproj" | head -1);
                if [ -n "$$csproj" ]; then
                  dotnet build "$$csproj" -c Release;
                else
                  dotnet build -c Release;
                fi'

            build-client-kotlin:
              image: gradle:8-jdk21
              volumes:
                - ./generated/client/kotlin:/src:rw
                - gradle-cache:/home/gradle/.gradle
              working_dir: /src
              command: gradle --no-daemon build -x test

            build-client-python:
              image: python:3.12-slim
              volumes:
                - ./generated/client/python:/src:rw
                - pip-cache:/root/.cache/pip
              working_dir: /src
              command: >
                sh -lc
                'pip install --no-cache-dir -e . 2>/dev/null || pip install --no-cache-dir -r requirements.txt 2>/dev/null || true;
                python -m compileall .'

          volumes:
            m2-cache:
            nuget-cache:
            npm-cache:
            pip-cache:
            go-pkg-cache:
            go-build-cache:
            gradle-cache:
          COMPOSEEOF

      - name: Ensure spec exists
        shell: bash
        run: |
          spec_path="${{ inputs.spec_path }}"
          case "$spec_path" in
            /*)
              echo "spec_path must be relative to the caller repo"
              exit 1
              ;;
          esac
          test -f "$spec_path"

      - name: Lint spec (Redocly)
        id: lint
        if: inputs.run_lint
        shell: bash
        continue-on-error: true
        env:
          SPEC_PATH: ${{ inputs.spec_path }}
          REDOCLY_IMAGE: ${{ inputs.redocly_image }}
          REDOCLY_CONFIG: ${{ inputs.redocly_config }}
        run: |
          set -euo pipefail

          log="${REPORTS_DIR}/lint/redocly.log"
          config_arg=""
          if [[ -n "${REDOCLY_CONFIG:-}" ]]; then
            config_arg="--config /work/${REDOCLY_CONFIG}"
          fi

          echo "::group::redocly lint"
          {
            echo "$ docker run --rm -v \${GITHUB_WORKSPACE}:/work -w /work ${REDOCLY_IMAGE} lint /work/${SPEC_PATH} ${config_arg}"
            echo ""
          } > "${log}"

          set +e
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            "${REDOCLY_IMAGE}" \
            lint "/work/${SPEC_PATH}" \
            ${config_arg} 2>&1 | tee -a "${log}"
          exit_code=${PIPESTATUS[0]}
          set -e
          echo "::endgroup::"

          if [[ "${exit_code}" -eq 0 ]]; then
            printf 'lint\tspec\tredocly\tok\t%s\n' "${log}" >> "${STATUS_FILE}"
          else
            printf 'lint\tspec\tredocly\tfail\t%s\n' "${log}" >> "${STATUS_FILE}"
          fi
          exit "${exit_code}"

      - name: Generate code (OpenAPI Generator)
        id: generate
        if: inputs.run_generate
        shell: bash
        continue-on-error: true
        env:
          SPEC_PATH: ${{ inputs.spec_path }}
          GENERATOR_IMAGE: ${{ inputs.generator_image }}
          MODE: ${{ inputs.mode }}
          SERVER_CONFIG_DIR: ${{ inputs.server_config_dir }}
          CLIENT_CONFIG_DIR: ${{ inputs.client_config_dir }}
          SERVER_GENERATORS: ${{ inputs.server_generators }}
          CLIENT_GENERATORS: ${{ inputs.client_generators }}
          USE_CALLER_CONFIGS: ${{ inputs.use_caller_configs }}
        run: |
          set -euo pipefail
          shopt -s nullglob

          spec="/work/${SPEC_PATH}"

          # Resolve config directories
          if [[ "${USE_CALLER_CONFIGS:-false}" == "true" ]]; then
            host_server_dir="${GITHUB_WORKSPACE}/${SERVER_CONFIG_DIR}"
            host_client_dir="${GITHUB_WORKSPACE}/${CLIENT_CONFIG_DIR}"
            container_server_dir="/work/${SERVER_CONFIG_DIR}"
            container_client_dir="/work/${CLIENT_CONFIG_DIR}"
          else
            host_server_dir="${GITHUB_WORKSPACE}/generators/server"
            host_client_dir="${GITHUB_WORKSPACE}/generators/client"
            container_server_dir="/work/generators/server"
            container_client_dir="/work/generators/client"
          fi

          case "${MODE}" in
            server|client|both)
              ;;
            *)
              echo "Invalid mode: ${MODE} (expected server, client, or both)" | tee -a "${REPORTS_DIR}/generate/_errors.log"
              printf 'generate\tmode\tinvalid\tfail\t%s\n' "${REPORTS_DIR}/generate/_errors.log" >> "${STATUS_FILE}"
              exit 1
              ;;
          esac

          generate_from_dir() {
            local host_dir="$1"
            local container_dir="$2"
            local list="$3"
            local label="$4"
            local configs=()
            local failures=0
            local error_log="${REPORTS_DIR}/generate/${label}/_errors.log"

            if [[ ! -d "${host_dir}" ]]; then
              echo "Missing ${label} config dir: ${host_dir}" | tee -a "${error_log}"
              printf 'generate\t%s\t_config_\tfail\t%s\n' "${label}" "${error_log}" >> "${STATUS_FILE}"
              return 1
            fi

            if [[ -n "${list}" ]]; then
              IFS=',' read -r -a gens <<< "${list}"
              for raw in "${gens[@]}"; do
                gen="$(echo "${raw}" | xargs)"
                if [[ -z "${gen}" ]]; then
                  continue
                fi
                config="${host_dir}/${gen}.yaml"
                if [[ ! -f "${config}" ]]; then
                  echo "Missing ${label} generator config: ${config}" | tee -a "${error_log}"
                  printf 'generate\t%s\t%s\tfail\t%s\n' "${label}" "${gen}" "${error_log}" >> "${STATUS_FILE}"
                  return 1
                fi
                configs+=("${config}")
              done
            else
              configs=("${host_dir}"/*.yaml)
            fi

            if [[ "${#configs[@]}" -eq 0 ]]; then
              echo "No ${label} generator configs found under ${host_dir}" | tee -a "${error_log}"
              printf 'generate\t%s\t_config_\tfail\t%s\n' "${label}" "${error_log}" >> "${STATUS_FILE}"
              return 1
            fi

            for config in "${configs[@]}"; do
              name="$(basename "${config}" .yaml)"
              config_container="${config/${host_dir}/${container_dir}}"
              log="${REPORTS_DIR}/generate/${label}/${name}.log"
              echo "::group::generate ${label} ${name}"

              {
                echo "$ docker run --rm --user $(id -u):$(id -g) -v \${GITHUB_WORKSPACE}:/work -w /work ${GENERATOR_IMAGE} generate -i ${spec} -c ${config_container}"
                echo ""
              } > "${log}"

              set +e
              docker run --rm \
                --user "$(id -u):$(id -g)" \
                -v "${GITHUB_WORKSPACE}:/work" \
                -w /work \
                "${GENERATOR_IMAGE}" \
                generate -i "${spec}" -c "${config_container}" 2>&1 | tee -a "${log}"
              exit_code=${PIPESTATUS[0]}
              set -e
              echo "::endgroup::"
              if [[ "${exit_code}" -eq 0 ]]; then
                printf 'generate\t%s\t%s\tok\t%s\n' "${label}" "${name}" "${log}" >> "${STATUS_FILE}"
              else
                printf 'generate\t%s\t%s\tfail\t%s\n' "${label}" "${name}" "${log}" >> "${STATUS_FILE}"
                failures=1
              fi
            done
            return "${failures}"
          }

          failures=0
          if [[ "${MODE}" == "server" ]] || [[ "${MODE}" == "both" ]]; then
            generate_from_dir "${host_server_dir}" "${container_server_dir}" "${SERVER_GENERATORS:-}" "server" || failures=1
          fi
          if [[ "${MODE}" == "client" ]] || [[ "${MODE}" == "both" ]]; then
            generate_from_dir "${host_client_dir}" "${container_client_dir}" "${CLIENT_GENERATORS:-}" "client" || failures=1
          fi

          # Fix permissions on generated directory
          if [[ -d "${GENERATED_DIR}" ]]; then
            chmod -R a+rw "${GENERATED_DIR}" 2>/dev/null || true
          fi

          exit "${failures}"

      - name: Compile generated code
        id: compile
        if: inputs.run_compile && inputs.run_generate
        shell: bash
        continue-on-error: true
        env:
          MODE: ${{ inputs.mode }}
          SERVER_GENERATORS: ${{ inputs.server_generators }}
          CLIENT_GENERATORS: ${{ inputs.client_generators }}
        run: |
          set -euo pipefail

          MODE="${MODE:-server}"
          error_log="${REPORTS_DIR}/compile/_errors.log"

          # Supported generators for compilation
          SUPPORTED_SERVER_GENERATORS=(aspnetcore go-server kotlin-spring python-fastapi spring typescript-nestjs)
          SUPPORTED_CLIENT_GENERATORS=(csharp go java kotlin python typescript-axios typescript-fetch typescript-node)

          is_supported_server() {
            local gen="$1"
            for supported in "${SUPPORTED_SERVER_GENERATORS[@]}"; do
              if [[ "${gen}" == "${supported}" ]]; then
                return 0
              fi
            done
            return 1
          }

          is_supported_client() {
            local gen="$1"
            for supported in "${SUPPORTED_CLIENT_GENERATORS[@]}"; do
              if [[ "${gen}" == "${supported}" ]]; then
                return 0
              fi
            done
            return 1
          }

          services=()

          # Add server generators if mode includes server
          if [[ "${MODE}" == "server" || "${MODE}" == "both" ]]; then
            if [[ -n "${SERVER_GENERATORS:-}" ]]; then
              IFS=',' read -r -a gens <<< "${SERVER_GENERATORS}"
              for raw in "${gens[@]}"; do
                gen="$(echo "${raw}" | xargs)"
                if [[ -z "${gen}" ]]; then
                  continue
                fi
                if ! is_supported_server "${gen}"; then
                  echo "Unsupported server generator for compile: ${gen}" | tee -a "${error_log}"
                  printf 'compile\tserver\t%s\tfail\t%s\n' "${gen}" "${error_log}" >> "${STATUS_FILE}"
                  exit 1
                fi
                services+=("server:build-${gen}:${gen}")
              done
            else
              for gen in "${SUPPORTED_SERVER_GENERATORS[@]}"; do
                services+=("server:build-${gen}:${gen}")
              done
            fi
          fi

          # Add client generators if mode includes client
          if [[ "${MODE}" == "client" || "${MODE}" == "both" ]]; then
            if [[ -n "${CLIENT_GENERATORS:-}" ]]; then
              IFS=',' read -r -a gens <<< "${CLIENT_GENERATORS}"
              for raw in "${gens[@]}"; do
                gen="$(echo "${raw}" | xargs)"
                if [[ -z "${gen}" ]]; then
                  continue
                fi
                if ! is_supported_client "${gen}"; then
                  echo "Unsupported client generator for compile: ${gen}" | tee -a "${error_log}"
                  printf 'compile\tclient\t%s\tfail\t%s\n' "${gen}" "${error_log}" >> "${STATUS_FILE}"
                  exit 1
                fi
                services+=("client:build-client-${gen}:${gen}")
              done
            else
              for gen in "${SUPPORTED_CLIENT_GENERATORS[@]}"; do
                services+=("client:build-client-${gen}:${gen}")
              done
            fi
          fi

          failures=0
          for entry in "${services[@]}"; do
            IFS=':' read -r type service name <<< "${entry}"
            mkdir -p "${REPORTS_DIR}/compile/${type}"
            log="${REPORTS_DIR}/compile/${type}/${service}.log"
            echo "::group::compile ${service}"

            {
              echo "$ docker compose -f docker-compose.yaml run --rm ${service}"
              echo ""
            } > "${log}"

            set +e
            docker compose -f "${GITHUB_WORKSPACE}/docker-compose.yaml" --project-directory "${GITHUB_WORKSPACE}" run --rm "${service}" 2>&1 | tee -a "${log}"
            exit_code=${PIPESTATUS[0]}
            set -e
            echo "::endgroup::"
            if [[ "${exit_code}" -eq 0 ]]; then
              printf 'compile\t%s\t%s\tok\t%s\n' "${type}" "${name}" "${log}" >> "${STATUS_FILE}"
            else
              printf 'compile\t%s\t%s\tfail\t%s\n' "${type}" "${name}" "${log}" >> "${STATUS_FILE}"
              failures=1
            fi
          done

          if [[ "${failures}" -ne 0 ]]; then
            exit 1
          fi

      - name: Summarize results
        if: always()
        shell: bash
        env:
          RUN_LINT: ${{ inputs.run_lint }}
          RUN_GENERATE: ${{ inputs.run_generate }}
          RUN_COMPILE: ${{ inputs.run_compile }}
          RUN_UPLOAD: ${{ inputs.run_upload }}
          LINT_OUTCOME: ${{ steps.lint.outcome }}
          GENERATE_OUTCOME: ${{ steps.generate.outcome }}
          COMPILE_OUTCOME: ${{ steps.compile.outcome }}
        run: |
          set -euo pipefail

          summary="${GITHUB_STEP_SUMMARY}"

          echo "## OpenAPI Tools Results" >> "${summary}"
          echo "" >> "${summary}"

          if [[ -f "${STATUS_FILE}" ]]; then
            # Lint section
            lint_line="$(awk -F '\t' '$1=="lint"' "${STATUS_FILE}" || true)"
            if [[ -n "${lint_line}" ]]; then
              lint_status="$(echo "${lint_line}" | awk -F '\t' '{print $4}')"
              lint_log="$(echo "${lint_line}" | awk -F '\t' '{print $5}')"
              echo "### Lint" >> "${summary}"
              echo "" >> "${summary}"
              echo "| Tool | Status | Log |" >> "${summary}"
              echo "|---|---|---|" >> "${summary}"
              echo "| Redocly | ${lint_status} | ${lint_log} |" >> "${summary}"
              echo "" >> "${summary}"
            fi

            if [[ "${RUN_LINT:-true}" != "true" ]]; then
              echo "### Lint" >> "${summary}"
              echo "" >> "${summary}"
              echo "Skipped (run_lint=false)" >> "${summary}"
              echo "" >> "${summary}"
            fi

            # Generate sections (server and client)
            for scope in server client; do
              entries="$(awk -F '\t' -v scope="${scope}" '$1=="generate" && $2==scope' "${STATUS_FILE}" || true)"
              if [[ -n "${entries}" ]]; then
                title="Generate (${scope})"
                echo "### ${title}" >> "${summary}"
                echo "" >> "${summary}"
                echo "| Generator | Status | Log |" >> "${summary}"
                echo "|---|---|---|" >> "${summary}"
                awk -F '\t' -v scope="${scope}" '$1=="generate" && $2==scope {printf("| %s | %s | %s |\n", $3, $4, $5)}' "${STATUS_FILE}" >> "${summary}"
                echo "" >> "${summary}"
              fi
            done

            if [[ "${RUN_GENERATE:-true}" != "true" ]]; then
              echo "### Generate" >> "${summary}"
              echo "" >> "${summary}"
              echo "Skipped (run_generate=false)" >> "${summary}"
              echo "" >> "${summary}"
            fi

            # Compile sections (server and client)
            for scope in server client; do
              entries="$(awk -F '\t' -v scope="${scope}" '$1=="compile" && $2==scope' "${STATUS_FILE}" || true)"
              if [[ -n "${entries}" ]]; then
                title="Compile (${scope})"
                echo "### ${title}" >> "${summary}"
                echo "" >> "${summary}"
                echo "| Target | Status | Log |" >> "${summary}"
                echo "|---|---|---|" >> "${summary}"
                awk -F '\t' -v scope="${scope}" '$1=="compile" && $2==scope {printf("| %s | %s | %s |\n", $3, $4, $5)}' "${STATUS_FILE}" >> "${summary}"
                echo "" >> "${summary}"
              fi
            done
          else
            echo "No status file found." >> "${summary}"
          fi

          if [[ "${RUN_COMPILE:-true}" != "true" ]]; then
            echo "### Compile" >> "${summary}"
            echo "" >> "${summary}"
            echo "Skipped (run_compile=false)" >> "${summary}"
            echo "" >> "${summary}"
          fi

          if [[ "${RUN_UPLOAD:-true}" == "true" ]]; then
            echo "Reports artifact: \`openapi-tools-reports\`" >> "${summary}"
            echo "" >> "${summary}"
          else
            echo "Reports artifact: skipped (run_upload=false)" >> "${summary}"
            echo "" >> "${summary}"
          fi

          # Count failures from status file
          if [[ -f "${STATUS_FILE}" ]]; then
            failures="$(awk -F '\t' '$4=="fail" {count++} END {print count+0}' "${STATUS_FILE}")"
          else
            failures=1
          fi

          # Check step outcomes
          step_failures=0
          if [[ "${RUN_LINT:-true}" == "true" ]] && [[ "${LINT_OUTCOME:-success}" == "failure" ]]; then
            step_failures=1
          fi
          if [[ "${RUN_GENERATE:-true}" == "true" ]] && [[ "${GENERATE_OUTCOME:-success}" == "failure" ]]; then
            step_failures=1
          fi
          if [[ "${RUN_COMPILE:-true}" == "true" ]] && [[ "${COMPILE_OUTCOME:-success}" == "failure" ]]; then
            step_failures=1
          fi

          if [[ "${failures}" -gt 0 ]]; then
            echo "Failures: ${failures}" >> "${summary}"
            exit 1
          fi

          if [[ "${step_failures}" -gt 0 ]]; then
            echo "Failures: at least one step failed before reporting status." >> "${summary}"
            exit 1
          fi

      - name: Generate HTML dashboard
        if: always() && inputs.run_upload
        shell: bash
        run: |
          set -euo pipefail

          html_escape() {
            sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'
          }

          output="${REPORTS_DIR}/dashboard.html"

          # Count results
          total=0 passed=0 failed=0
          if [[ -f "${STATUS_FILE}" ]]; then
            total=$(wc -l < "${STATUS_FILE}" | tr -d ' ')
            passed=$(awk -F'\t' '$4=="ok"' "${STATUS_FILE}" | wc -l | tr -d ' ')
            failed=$(awk -F'\t' '$4=="fail"' "${STATUS_FILE}" | wc -l | tr -d ' ')
          fi

          cat > "${output}" << 'HTMLHEAD'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OpenAPI Tools Report</title>
            <style>
              :root {
                --bg: #0d1117; --fg: #c9d1d9; --border: #30363d;
                --green: #238636; --red: #da3633; --yellow: #d29922;
                --link: #58a6ff; --code-bg: #161b22;
              }
              * { box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                     background: var(--bg); color: var(--fg); margin: 0; padding: 20px; line-height: 1.5; }
              h1, h2, h3 { margin-top: 0; font-weight: 600; }
              h1 { border-bottom: 1px solid var(--border); padding-bottom: 10px; }
              .summary { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
              .stat { background: var(--code-bg); border: 1px solid var(--border); border-radius: 6px;
                      padding: 16px 24px; text-align: center; min-width: 120px; }
              .stat-value { font-size: 2em; font-weight: 600; }
              .stat-label { color: #8b949e; font-size: 0.9em; }
              .stat.pass .stat-value { color: var(--green); }
              .stat.fail .stat-value { color: var(--red); }
              .section { margin-bottom: 30px; }
              .result-table { width: 100%; border-collapse: collapse; background: var(--code-bg);
                             border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
              .result-table th, .result-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
              .result-table th { background: var(--bg); font-weight: 600; }
              .result-table tr:last-child td { border-bottom: none; }
              .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 500; }
              .badge.ok { background: var(--green); color: #fff; }
              .badge.fail { background: var(--red); color: #fff; }
              details { background: var(--code-bg); border: 1px solid var(--border); border-radius: 6px; margin-top: 10px; }
              summary { padding: 12px; cursor: pointer; font-weight: 500; }
              summary:hover { background: var(--border); }
              pre { margin: 0; padding: 16px; overflow-x: auto; font-size: 0.85em;
                    background: var(--bg); border-top: 1px solid var(--border); max-height: 500px; overflow-y: auto; }
              code { font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace; }
              a { color: var(--link); text-decoration: none; }
              a:hover { text-decoration: underline; }
              .empty { color: #8b949e; font-style: italic; }
            </style>
          </head>
          <body>
            <h1>OpenAPI Tools Report</h1>
            <div class="summary">
          HTMLHEAD

          # Summary stats
          cat >> "${output}" << HTMLSTATS
              <div class="stat">
                <div class="stat-value">${total}</div>
                <div class="stat-label">Total</div>
              </div>
              <div class="stat pass">
                <div class="stat-value">${passed}</div>
                <div class="stat-label">Passed</div>
              </div>
              <div class="stat fail">
                <div class="stat-value">${failed}</div>
                <div class="stat-label">Failed</div>
              </div>
            </div>
          HTMLSTATS

          # Results by section
          for section in lint generate compile; do
            case "${section}" in
              lint) section_title="Lint" ;;
              generate) section_title="Generate" ;;
              compile) section_title="Compile" ;;
            esac

            entries=""
            if [[ -f "${STATUS_FILE}" ]]; then
              entries=$(awk -F'\t' -v s="${section}" '$1==s' "${STATUS_FILE}" || true)
            fi

            if [[ -n "${entries}" ]]; then
              cat >> "${output}" << HTMLSECTION
            <div class="section">
              <h2>${section_title}</h2>
              <table class="result-table">
                <thead>
                  <tr><th>Scope</th><th>Target</th><th>Status</th><th>Log</th></tr>
                </thead>
                <tbody>
          HTMLSECTION

              while IFS=$'\t' read -r stage scope target status logpath; do
                badge_class="${status}"
                log_content=""
                log_basename=""

                if [[ -f "${logpath}" ]]; then
                  log_basename=$(basename "${logpath}")
                  log_content=$(head -c 100000 "${logpath}" | html_escape || echo "Could not read log")
                else
                  log_content="Log file not found: ${logpath}"
                fi

                cat >> "${output}" << HTMLROW
                  <tr>
                    <td>${scope}</td>
                    <td>${target}</td>
                    <td><span class="badge ${badge_class}">${status}</span></td>
                    <td>
                      <details>
                        <summary>${log_basename:-log}</summary>
                        <pre><code>${log_content}</code></pre>
                      </details>
                    </td>
                  </tr>
          HTMLROW
              done <<< "${entries}"

              cat >> "${output}" << 'HTMLSECTIONEND'
                </tbody>
              </table>
            </div>
          HTMLSECTIONEND
            fi
          done

          # Footer
          cat >> "${output}" << 'HTMLFOOT'
            <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); color: #8b949e; font-size: 0.85em;">
              Generated by the reusable GHA workflow <a href="https://github.com/entur/gha-openapi-tools">OpenAPI Tools</a> from Entur.
            </footer>
          </body>
          </html>
          HTMLFOOT

          echo "Generated reports dashboard: ${output}"

      - name: Upload reports artifact
        if: always() && inputs.run_upload
        uses: actions/upload-artifact@v4
        with:
          name: openapi-tools-reports
          path: ${{ env.REPORTS_DIR }}

      - name: Upload generated code artifact
        if: always() && inputs.run_upload_generated && inputs.run_generate
        uses: actions/upload-artifact@v4
        with:
          name: openapi-generated-code
          path: ${{ env.GENERATED_DIR }}
